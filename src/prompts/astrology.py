"""
西洋占星術 Gemini 提示詞模板
遵循「有所本」原則：所有解釋必須引用占星學經典理論
"""

def get_natal_chart_analysis_prompt(natal_chart_text: str, user_facts: dict = None) -> str:
    """
    本命盤分析提示詞
    
    Args:
        natal_chart_text: 格式化的本命盤數據
        user_facts: 用戶已知事實（用於交叉驗證）
    """
    
    user_context = ""
    if user_facts:
        user_context = f"""
【用戶已知事實】（請用於交叉驗證）
{format_user_facts(user_facts)}
"""
    
    prompt = f"""
你是專精西洋占星術的命理分析師，遵循以下核心原則：

【核心原則】
1. **有所本**：所有解釋必須引用占星學經典理論來源
2. **證據導向**：基於實際星盤配置，不憑空臆測
3. **交叉驗證**：當有用戶已知事實時，需與星盤配置相互驗證
4. **中立客觀**：避免過度正面或負面的判斷

【分析任務】
請根據以下本命盤進行全面分析：

{natal_chart_text}
{user_context}

【分析架構】

## 一、核心人格特質（太陽、月亮、上升）

### 1. 太陽星座（核心自我）
- 【星座特質】：基於太陽所在星座與度數
- 【宮位表現】：太陽所在宮位的生命主題
- 【理論依據】：引用經典占星著作（如 Stephen Arroyo, Liz Greene）
- 【實證對照】：若有用戶已知事實，說明符合或差異

### 2. 月亮星座（情感需求）
- 【情緒模式】：月亮星座的情感表達方式
- 【安全感來源】：月亮宮位指示的需求領域
- 【理論依據】：引用月亮占星學理論
- 【實證對照】：與用戶情感經驗比對

### 3. 上升星座（外在表現）
- 【第一印象】：上升星座的外在形象
- 【命主星分析】：命主星的位置與狀態
- 【理論依據】：引用上升點占星學
- 【實證對照】：與他人對用戶的印象比對

## 二、行星能量分析

### 1. 水星（溝通思考）
- 【思維模式】：水星星座的思考特質
- 【溝通風格】：水星宮位的表達領域
- 【逆行影響】：若逆行，說明特殊影響
- 【理論依據】：水星占星學理論

### 2. 金星（愛情價值觀）
- 【愛情觀】：金星星座的愛情模式
- 【審美傾向】：金星星座的美感偏好
- 【關係宮位】：金星所在宮位的愛情表現
- 【理論依據】：金星占星學理論

### 3. 火星（行動力與慾望）
- 【行動模式】：火星星座的驅動方式
- 【慾望表達】：火星宮位的能量展現
- 【理論依據】：火星占星學理論

### 4. 木星（幸運與擴張）
- 【幸運領域】：木星星座與宮位的機會
- 【成長方向】：木星指示的發展潛能
- 【理論依據】：木星占星學理論

### 5. 土星（挑戰與成長）
- 【人生課題】：土星星座與宮位的考驗
- 【成熟領域】：土星帶來的智慧
- 【理論依據】：土星占星學理論

### 6. 外行星（世代影響）
- 【天王星】：創新與突破的領域
- 【海王星】：靈性與理想的面向
- 【冥王星】：轉化與重生的主題

## 三、宮位生活領域

依序分析各宮位的星座與落入行星：
- 第1宮（自我）
- 第2宮（金錢）
- 第3宮（溝通）
- 第4宮（家庭）
- 第5宮（創造）
- 第6宮（工作）
- 第7宮（關係）
- 第8宮（轉化）
- 第9宮（哲學）
- 第10宮（事業）
- 第11宮（社群）
- 第12宮（潛意識）

## 四、相位關係

### 主要相位分析
針對本命盤中的主要相位（合、沖、拱、刑、六合），分析：
- 【相位含義】：該相位的占星學意義
- 【能量互動】：兩顆行星如何互相影響
- 【生活表現】：該相位在實際生活中的體現
- 【理論依據】：引用相位占星學理論

## 五、元素與型態

### 元素平衡
- 【火】：行動力、熱情、創造力
- 【土】：穩定性、務實、執行力
- 【風】：思考力、社交、靈活性
- 【水】：情感、直覺、同理心

### 型態分佈
- 【開創】：主動發起的能力
- 【固定】：堅持穩定的特質
- 【變動】：適應變化的能力

### 失衡影響
若某元素或型態過多或過少，說明其影響與建議

## 六、整合解讀

### 1. 核心矛盾與整合
- 識別星盤中的矛盾配置（如太陽與月亮的衝突）
- 提供整合建議

### 2. 人生主題
- 基於整體星盤配置，歸納3-5個核心人生主題

### 3. 發展建議
- 基於土星、木星、北交點等，提供成長方向

## 七、交叉驗證與問題

### 1. 與已知事實的比對
若提供了用戶已知事實，逐一比對：
- ✅ 符合：說明星盤配置的支持證據
- ⚠️ 部分符合：說明可能的其他因素
- ❌ 不符合：說明可能需要更多資訊或其他解釋角度

### 2. 需要補充的問題
若星盤某些配置需要更多資訊才能準確解讀，列出問題：
- 例如：「你的父母關係如何？」（第4宮有重要配置時）
- 例如：「你的職業是什麼？」（第10宮有特殊行星時）

## 八、參考文獻

列出本次分析引用的占星學理論來源，例如：
- Stephen Arroyo, "Astrology, Psychology, and the Four Elements"
- Liz Greene, "Saturn: A New Look at an Old Devil"
- Robert Hand, "Planets in Transit"
- Sue Tompkins, "Aspects in Astrology"

【輸出格式要求】
1. 使用繁體中文（台灣用語）
2. 每個主張都要引用理論來源
3. 避免模糊或籠統的描述
4. 用具體的行為模式或心理狀態描述
5. 保持中立與客觀

現在請開始分析。
"""
    
    return prompt


def get_synastry_analysis_prompt(chart1_text: str, chart2_text: str, 
                                 relationship_facts: dict = None) -> str:
    """
    合盤分析提示詞（兩人關係）
    
    Args:
        chart1_text: 第一人的本命盤
        chart2_text: 第二人的本命盤
        relationship_facts: 兩人關係的已知事實
    """
    
    relationship_context = ""
    if relationship_facts:
        relationship_context = f"""
【關係已知事實】
{format_relationship_facts(relationship_facts)}
"""
    
    prompt = f"""
你是專精合盤分析的西洋占星師，遵循「有所本」與「實證導向」原則。

【分析任務】
分析以下兩人的合盤關係：

【第一人本命盤】
{chart1_text}

【第二人本命盤】
{chart2_text}
{relationship_context}

【分析架構】

## 一、核心相容性

### 1. 太陽-太陽
- 兩人太陽的相位關係
- 核心價值觀的契合度
- 【理論依據】：引用合盤占星學

### 2. 月亮-月亮
- 情感需求的互動
- 情緒共鳴程度
- 【理論依據】：月亮合盤理論

### 3. 金星-火星
- 愛情與吸引力動態
- 性能量的和諧度
- 【理論依據】：關係占星學

## 二、關係動力

### 1. 溝通模式（水星相位）
### 2. 衝突模式（火星相位）
### 3. 承諾態度（土星相位）
### 4. 成長機會（木星相位）

## 三、宮位重疊

分析一人的行星落入另一人的宮位，說明：
- 影響的生活領域
- 互動的主題

## 四、整合建議

### 1. 關係優勢
### 2. 挑戰領域
### 3. 相處建議
### 4. 交叉驗證（若有關係事實）

【輸出格式】
- 繁體中文（台灣用語）
- 引用理論來源
- 實證導向
- 中立客觀

現在請開始分析。
"""
    
    return prompt


def get_transit_analysis_prompt(natal_chart_text: str, transit_date: str) -> str:
    """
    流年運勢分析提示詞
    
    Args:
        natal_chart_text: 本命盤數據
        transit_date: 要分析的日期
    """
    
    prompt = f"""
你是專精流年運勢的西洋占星師，遵循「有所本」原則。

【分析任務】
分析 {transit_date} 的流年運勢：

【本命盤】
{natal_chart_text}

【分析架構】

## 一、外行星流年（長期影響）

### 1. 木星流年（約1年）
- 當前木星位置
- 與本命行星的相位
- 【機會領域】
- 【理論依據】

### 2. 土星流年（約2.5年）
- 當前土星位置
- 與本命行星的相位
- 【考驗領域】
- 【理論依據】

### 3. 天王星、海王星、冥王星流年（長期）
- 若有重要相位，深入分析

## 二、內行星流年（短期影響）

### 1. 太陽流年（約1個月）
### 2. 水星流年（快速變動）
### 3. 金星流年（愛情與金錢）
### 4. 火星流年（行動與衝突）

## 三、月相與食相

### 1. 新月/滿月影響
### 2. 日月食影響（若有）

## 四、整合建議

### 1. 本期重點
### 2. 注意事項
### 3. 行動建議

【輸出格式】
- 繁體中文（台灣用語）
- 引用理論來源
- 具體可行的建議

現在請開始分析。
"""
    
    return prompt


def get_career_analysis_prompt(natal_chart_text: str, career_facts: dict = None) -> str:
    """
    事業發展分析提示詞
    
    Args:
        natal_chart_text: 本命盤數據
        career_facts: 事業相關已知事實
    """
    
    career_context = ""
    if career_facts:
        career_context = f"""
【事業已知事實】
目前職業：{career_facts.get('current_job', '未提供')}
工作經歷：{career_facts.get('work_history', '未提供')}
職業目標：{career_facts.get('career_goal', '未提供')}
"""
    
    prompt = f"""
你是專精事業占星的分析師，遵循「有所本」與「實證導向」原則。

【分析任務】
分析事業發展方向與潛能：

【本命盤】
{natal_chart_text}
{career_context}

【分析架構】

## 一、事業宮位分析

### 1. 第10宮（事業成就）
- 宮頭星座
- 落入行星
- 【事業方向】
- 【理論依據】

### 2. 第6宮（日常工作）
- 工作態度
- 服務型態
- 【理論依據】

### 3. 第2宮（收入來源）
- 賺錢方式
- 金錢觀
- 【理論依據】

## 二、事業行星

### 1. 太陽（事業核心）
### 2. 土星（紀律與成就）
### 3. 木星（擴張與機會）
### 4. 火星（行動力）

## 三、天賦才能

### 1. 元素分析
- 適合的工作類型（火/土/風/水）

### 2. 型態分析
- 工作風格（開創/固定/變動）

### 3. 北交點
- 靈魂使命與發展方向

## 四、整合建議

### 1. 適合的職業領域
### 2. 發展策略
### 3. 需要注意的挑戰
### 4. 交叉驗證（若有事業事實）

【輸出格式】
- 繁體中文（台灣用語）
- 引用理論來源
- 具體職業建議

現在請開始分析。
"""
    
    return prompt


def format_user_facts(user_facts: dict) -> str:
    """格式化用戶已知事實"""
    output = []
    for key, value in user_facts.items():
        output.append(f"- {key}：{value}")
    return "\n".join(output)


def format_relationship_facts(relationship_facts: dict) -> str:
    """格式化關係已知事實"""
    output = []
    for key, value in relationship_facts.items():
        output.append(f"- {key}：{value}")
    return "\n".join(output)


if __name__ == '__main__':
    # 測試提示詞生成
    test_chart = """
【本命盤】測試者
出生日期：1990-01-01
太陽：摩羯座 10° 第5宮
月亮：巨蟹座 15° 第11宮
上升：處女座 5°
"""
    
    prompt = get_natal_chart_analysis_prompt(
        natal_chart_text=test_chart,
        user_facts={
            '性格特質': '內向、理性、重視計劃',
            '工作類型': '軟體工程師',
            '感情狀態': '單身，不急於戀愛'
        }
    )
    
    print(prompt[:500] + "...\n[提示詞已生成，總長度：" + str(len(prompt)) + " 字]")

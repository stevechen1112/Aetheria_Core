"""
æ•æ„Ÿè­°é¡Œæª¢æ¸¬èˆ‡æ””æˆªæ¨¡çµ„
åµæ¸¬å¥åº·ã€ç”Ÿæ­»ã€æ³•å¾‹ç­‰å±éšªè©±é¡Œä¸¦æä¾›ä¿è­·æ€§å›æ‡‰

ç‰ˆæœ¬: v1.0.0
æœ€å¾Œæ›´æ–°: 2026-02-05
"""

import re
from typing import Dict, List, Tuple, Optional
from enum import Enum

from src.utils.logger import get_logger

logger = get_logger()


class SensitiveTopic(Enum):
    """æ•æ„Ÿè©±é¡Œé¡åˆ¥"""
    HEALTH_MEDICAL = "health_medical"          # å¥åº·é†«ç™‚
    SUICIDE_DEATH = "suicide_death"            # è‡ªæ®ºæ­»äº¡
    LEGAL_CRIME = "legal_crime"                # æ³•å¾‹çŠ¯ç½ª
    FINANCIAL_INVESTMENT = "financial_investment"  # é‡‘èæŠ•è³‡
    RELATIONSHIP_VIOLENCE = "relationship_violence"  # é—œä¿‚æš´åŠ›
    NONE = "none"                              # ç„¡æ•æ„Ÿè­°é¡Œ


class SensitiveTopicDetector:
    """æ•æ„Ÿè­°é¡Œæª¢æ¸¬å™¨"""
    
    # å¥åº·é†«ç™‚é—œéµè©
    HEALTH_PATTERNS = [
        r'å¾—äº†.*ç—…',
        r'(?:ç™Œç—‡|è…«ç˜¤|ç™½è¡€ç—…|ç³–å°¿ç—…|é«˜è¡€å£“|å¿ƒè‡Ÿç—…)',
        r'(?:ç¢ºè¨º|æª¢æŸ¥å‡º|é†«ç”Ÿèªª)',
        r'(?:åƒè—¥|æ²»ç™‚|æ‰‹è¡“|åŒ–ç™‚|æ”¾ç™‚)',
        r'(?:ç—…æƒ…|ç—…æ³|ç—‡ç‹€)',
        r'è¦ä¸è¦.*(?:çœ‹é†«ç”Ÿ|å°±é†«|æ²»ç™‚)',
        r'(?:èº«é«”ä¸é©|ä¸èˆ’æœ).*(?:æ€éº¼è¾¦|è©²æ€)',
    ]
    
    # è‡ªæ®ºæ­»äº¡é—œéµè©
    SUICIDE_PATTERNS = [
        r'(?:æƒ³æ­»|è‡ªæ®º|è¼•ç”Ÿ|äº†çµ)',
        r'(?:æ´»ä¸ä¸‹å»|ä¸æƒ³æ´»)',
        r'(?:éºæ›¸|å‘Šåˆ¥)',
        r'(?:è·³æ¨“|å‰²è…•|æœæ¯’|ä¸ŠåŠ)',
        r'(?:ç”Ÿå‘½.*æ„ç¾©|æ´»è‘—.*æ„ç¾©)',
        r'(?:æ­».*è§£è„«|ä¸€äº†ç™¾äº†)',
    ]
    
    # æ³•å¾‹çŠ¯ç½ªé—œéµè©
    LEGAL_PATTERNS = [
        r'(?:æ®ºäºº|è¬€æ®º|å‚·å®³)',
        r'(?:è©é¨™|ç›œç«Š|æ¶åŠ«)',
        r'(?:ç¶æ¶|å‹’ç´¢|æåš‡)',
        r'(?:éæ³•|é•æ³•|çŠ¯æ³•)',
        r'(?:é€ƒé¿.*è²¬ä»»|é€ƒé¿.*æ³•å¾‹)',
        r'æœƒä¸æœƒ.*(?:åç‰¢|å…¥ç„|åˆ¤åˆ‘)',
    ]
    
    # é‡‘èæŠ•è³‡é—œéµè©ï¼ˆéå°ˆæ¥­å»ºè­°å…è²¬ï¼‰
    FINANCIAL_PATTERNS = [
        r'(?:è‚¡ç¥¨|åŸºé‡‘|æœŸè²¨|é¸æ“‡æ¬Š)',
        r'(?:è²·.*è³º|è³£.*è™§)',
        r'(?:æŠ•è³‡.*å»ºè­°|ç†è²¡.*å»ºè­°)',
        r'(?:è³ºéŒ¢|ç™¼è²¡|è‡´å¯Œ)',
        r'(?:è²¸æ¬¾|å€ŸéŒ¢|è² å‚µ)',
        r'æœƒä¸æœƒ.*(?:å€’é–‰|ç ´ç”¢)',
    ]
    
    # é—œä¿‚æš´åŠ›é—œéµè©
    VIOLENCE_PATTERNS = [
        r'(?:å®¶æš´|è™å¾…|æ¯†æ‰“)',
        r'(?:è¢«.*æ‰“|è¢«.*ç½µ)',
        r'(?:å—å‚·|ç˜€é’|éª¨æŠ˜)',
        r'(?:å ±è­¦|é©—å‚·|é›¢å©š)',
        r'(?:æ§åˆ¶|å¨è„…|æåš‡)',
    ]
    
    def __init__(self):
        """åˆå§‹åŒ–æª¢æ¸¬å™¨"""
        self.patterns = {
            SensitiveTopic.HEALTH_MEDICAL: [re.compile(p, re.IGNORECASE) for p in self.HEALTH_PATTERNS],
            SensitiveTopic.SUICIDE_DEATH: [re.compile(p, re.IGNORECASE) for p in self.SUICIDE_PATTERNS],
            SensitiveTopic.LEGAL_CRIME: [re.compile(p, re.IGNORECASE) for p in self.LEGAL_PATTERNS],
            SensitiveTopic.FINANCIAL_INVESTMENT: [re.compile(p, re.IGNORECASE) for p in self.FINANCIAL_PATTERNS],
            SensitiveTopic.RELATIONSHIP_VIOLENCE: [re.compile(p, re.IGNORECASE) for p in self.VIOLENCE_PATTERNS],
        }
    
    def detect(self, text: str) -> Tuple[SensitiveTopic, float]:
        """
        æª¢æ¸¬æ–‡æœ¬æ˜¯å¦åŒ…å«æ•æ„Ÿè­°é¡Œ
        
        Args:
            text: å¾…æª¢æ¸¬æ–‡æœ¬
            
        Returns:
            (topic: SensitiveTopic, confidence: float)
            confidence ç‚º 0.0-1.0ï¼Œè¡¨ç¤ºåŒ¹é…å¼·åº¦
        """
        if not text:
            return SensitiveTopic.NONE, 0.0
        
        # è¨ˆç®—æ¯å€‹é¡åˆ¥çš„åŒ¹é…åˆ†æ•¸
        scores = {}
        for topic, patterns in self.patterns.items():
            matches = 0
            for pattern in patterns:
                if pattern.search(text):
                    matches += 1
            
            # æ­¸ä¸€åŒ–åˆ†æ•¸
            if matches > 0:
                scores[topic] = min(matches / len(patterns), 1.0)
        
        if not scores:
            return SensitiveTopic.NONE, 0.0
        
        # è¿”å›æœ€é«˜åˆ†çš„é¡åˆ¥
        max_topic = max(scores, key=scores.get)
        max_score = scores[max_topic]
        
        logger.info(f"æ•æ„Ÿè­°é¡Œæª¢æ¸¬: {max_topic.value} (ä¿¡å¿ƒåº¦: {max_score:.2f})")
        
        return max_topic, max_score
    
    def get_protective_response(self, topic: SensitiveTopic) -> str:
        """
        æ ¹æ“šæ•æ„Ÿè­°é¡Œé¡åˆ¥è¿”å›ä¿è­·æ€§å›æ‡‰
        
        Args:
            topic: æ•æ„Ÿè­°é¡Œé¡åˆ¥
            
        Returns:
            ä¿è­·æ€§å›æ‡‰æ–‡æœ¬
        """
        responses = {
            SensitiveTopic.HEALTH_MEDICAL: """ä½ æåˆ°äº†å¥åº·ç›¸é—œçš„å•é¡Œã€‚æˆ‘å¿…é ˆæé†’ä½ ï¼š

âš ï¸ **é‡è¦æé†’**
å‘½ç†è«®è©¢ä¸èƒ½å–ä»£å°ˆæ¥­é†«ç™‚è¨ºæ–·å’Œæ²»ç™‚ã€‚å¦‚æœä½ æœ‰èº«é«”ä¸é©æˆ–å¥åº·ç–‘æ…®ï¼Œè«‹å‹™å¿…ï¼š
1. ç«‹å³å°±é†«ï¼Œå°‹æ±‚å°ˆæ¥­é†«å¸«çš„è¨ºæ–·
2. éµå¾ªé†«å›‘ï¼ŒæŒ‰æ™‚æœè—¥å’Œæ²»ç™‚
3. å®šæœŸè¿½è¹¤æª¢æŸ¥

æˆ‘å¯ä»¥å¾å‘½ç†è§’åº¦æä¾›å¿ƒç†æ”¯æŒå’Œæ­£å‘å¼•å°ï¼Œä½†å¥åº·å•é¡Œå¿…é ˆç”±é†«ç™‚å°ˆæ¥­äººå“¡è™•ç†ã€‚

å¦‚æœä½ æƒ³è¨è«–å¿ƒç†èª¿é©æˆ–å£“åŠ›ç®¡ç†ï¼Œæˆ‘å¾ˆæ¨‚æ„é™ªä¼´ä½ ã€‚""",
            
            SensitiveTopic.SUICIDE_DEATH: """æˆ‘æ³¨æ„åˆ°ä½ å¯èƒ½æ­£åœ¨ç¶“æ­·å›°é›£çš„æ™‚åˆ»ã€‚è«‹è®“æˆ‘å¹«åŠ©ä½ ï¼š

ğŸ†˜ **ç·Šæ€¥æ±‚åŠ©è³‡æº**
â€¢ ğŸ“ ç”Ÿå‘½ç·šï¼š1995ï¼ˆ24å°æ™‚å…è²»ï¼‰
â€¢ ğŸ“ å¼µè€å¸«ï¼š1980ï¼ˆ24å°æ™‚å…è²»ï¼‰
â€¢ ğŸ“ å®‰å¿ƒå°ˆç·šï¼š1925ï¼ˆ24å°æ™‚å…è²»ï¼‰

ä½ çš„ç”Ÿå‘½å¾ˆå¯¶è²´ï¼Œå³ä½¿ç¾åœ¨æ„Ÿåˆ°ç—›è‹¦ï¼Œä½†é€™ä¸æœƒæ˜¯æ°¸é ã€‚å¾ˆå¤šäººç¶“æ­·éé¡ä¼¼çš„å›°å¢ƒå¾Œï¼Œéƒ½æ‰¾åˆ°äº†èµ°å‡ºä¾†çš„æ–¹æ³•ã€‚

å¦‚æœä½ é¡˜æ„ï¼Œæˆ‘å¯ä»¥ï¼š
1. é™ªä½ èŠèŠç•¶ä¸‹çš„æ„Ÿå—
2. ä¸€èµ·å°‹æ‰¾å¯èƒ½çš„æ”¯æŒè³‡æº
3. å¾å‘½ç†è§’åº¦å¹«ä½ çœ‹åˆ°ç”Ÿå‘½çš„å¦ä¸€ç¨®å¯èƒ½

ä½†è«‹è¨˜ä½ï¼Œæˆ‘ä¸æ˜¯å°ˆæ¥­å¿ƒç†è«®è©¢å¸«ã€‚å¦‚æœæƒ…æ³ç·Šæ€¥ï¼Œè«‹ç«‹å³æ’¥æ‰“ä¸Šè¿°å°ˆç·šã€‚""",
            
            SensitiveTopic.LEGAL_CRIME: """ä½ æåˆ°äº†æ³•å¾‹ç›¸é—œçš„å•é¡Œã€‚æˆ‘éœ€è¦èªªæ˜ï¼š

âš–ï¸ **é‡è¦è²æ˜**
å‘½ç†è«®è©¢ä¸èƒ½æä¾›æ³•å¾‹å»ºè­°æˆ–åˆ¤æ–·ã€‚å¦‚æœä½ é¢è‡¨æ³•å¾‹å•é¡Œï¼Œè«‹ï¼š
1. è«®è©¢å°ˆæ¥­å¾‹å¸«ï¼Œäº†è§£ä½ çš„æ¬Šåˆ©å’Œç¾©å‹™
2. å°‹æ±‚æ³•å¾‹æ‰¶åŠ©åŸºé‡‘æœƒçš„å”åŠ©ï¼ˆå…è²»æ³•å¾‹è«®è©¢ï¼‰
3. å¿…è¦æ™‚å ±è­¦æˆ–å‘ç›¸é—œå–®ä½æ±‚åŠ©

æˆ‘å¯ä»¥å¾å‘½ç†è§’åº¦è¨è«–ï¼š
â€¢ å¦‚ä½•é¢å°å£“åŠ›å’Œç„¦æ…®
â€¢ å€‹äººæ€§æ ¼ç‰¹è³ªèˆ‡æ±ºç­–æ¨¡å¼
â€¢ æœªä¾†è¦åŠƒèˆ‡å¿ƒç†èª¿é©

ä½†æ¶‰åŠæ³•å¾‹è²¬ä»»çš„å•é¡Œï¼Œå¿…é ˆç”±å°ˆæ¥­äººå£«è™•ç†ã€‚""",
            
            SensitiveTopic.FINANCIAL_INVESTMENT: """ä½ æåˆ°äº†æŠ•è³‡ç†è²¡çš„å•é¡Œã€‚è®“æˆ‘èªªæ˜ï¼š

ğŸ’° **æŠ•è³‡å…è²¬è²æ˜**
å‘½ç†è«®è©¢ä¸æ§‹æˆæŠ•è³‡å»ºè­°ï¼Œä¸æ‡‰ä½œç‚ºæŠ•è³‡æ±ºç­–çš„ä¾æ“šã€‚æŠ•è³‡æœ‰é¢¨éšªï¼Œè«‹ï¼š
1. è«®è©¢åˆæ ¼çš„è²¡å‹™é¡§å•
2. ä»”ç´°è©•ä¼°è‡ªå·±çš„é¢¨éšªæ‰¿å—èƒ½åŠ›
3. ä¸è¦æŠ•è³‡è¶…éä½ èƒ½æ‰¿å—çš„æå¤±

æˆ‘å¯ä»¥å¾å‘½ç†è§’åº¦åˆ†äº«ï¼š
â€¢ å€‹äººè²¡é‹è¶¨å‹¢çš„åƒè€ƒ
â€¢ æ€§æ ¼ç‰¹è³ªèˆ‡ç†è²¡é¢¨æ ¼
â€¢ å¿ƒç†ç´ è³ªèˆ‡æ±ºç­–æ¨¡å¼

ä½†å…·é«”çš„æŠ•è³‡æ±ºç­–ï¼Œè«‹å‹™å¿…è‡ªè¡Œå¯©æ…è©•ä¼°æˆ–å°‹æ±‚å°ˆæ¥­å”åŠ©ã€‚""",
            
            SensitiveTopic.RELATIONSHIP_VIOLENCE: """æˆ‘å¯Ÿè¦ºåˆ°ä½ å¯èƒ½é­é‡äº†é—œä¿‚ä¸­çš„å›°å¢ƒã€‚è«‹çŸ¥é“ï¼š

ğŸ›¡ï¸ **ä¿è­·è³‡æº**
â€¢ ğŸ“ 113ä¿è­·å°ˆç·šï¼ˆ24å°æ™‚å…è²»ï¼Œå©¦å¹¼ä¿è­·ï¼‰
â€¢ ğŸ“ 110å ±è­¦å°ˆç·šï¼ˆç·Šæ€¥ç‹€æ³ï¼‰
â€¢ å„ç¸£å¸‚å®¶åº­æš´åŠ›é˜²æ²»ä¸­å¿ƒ

âš ï¸ **é‡è¦æé†’**
1. ä½ çš„å®‰å…¨æ˜¯æœ€é‡è¦çš„ï¼Œå¦‚æœè™•æ–¼å±éšªä¸­è«‹ç«‹å³æ±‚åŠ©
2. æ²’æœ‰äººæ‡‰è©²é­å—æš´åŠ›å°å¾…
3. é€™ä¸æ˜¯ä½ çš„éŒ¯

æˆ‘å¯ä»¥ï¼š
â€¢ é™ªä¼´ä½ æ¢³ç†æƒ…ç·’
â€¢ å¾å‘½ç†è§’åº¦çœ‹å¾…é—œä¿‚æ¨¡å¼
â€¢ è¨è«–å¦‚ä½•ä¿è­·è‡ªå·±

ä½†å¦‚æœæ¶‰åŠäººèº«å®‰å…¨ï¼Œè«‹å‹™å¿…å°‹æ±‚å°ˆæ¥­å”åŠ©æˆ–å ±è­¦ã€‚ä½ å€¼å¾—è¢«å°Šé‡å°å¾…ã€‚""",
        }
        
        return responses.get(topic, "")
    
    def should_intercept(self, topic: SensitiveTopic, confidence: float, threshold: float = 0.3) -> bool:
        """
        åˆ¤æ–·æ˜¯å¦æ‡‰è©²æ””æˆªä¸¦æ’å…¥ä¿è­·æ€§å›æ‡‰
        
        Args:
            topic: æª¢æ¸¬åˆ°çš„æ•æ„Ÿè­°é¡Œ
            confidence: åŒ¹é…ä¿¡å¿ƒåº¦
            threshold: æ””æˆªé–¾å€¼ï¼ˆé è¨­ 0.3ï¼‰
            
        Returns:
            æ˜¯å¦æ‡‰è©²æ””æˆª
        """
        if topic == SensitiveTopic.NONE:
            return False
        
        # è‡ªæ®ºæ­»äº¡è­°é¡Œï¼šä½é–¾å€¼ï¼ˆ0.2ï¼‰ï¼Œæ›´ç©æ¥µæ””æˆª
        if topic == SensitiveTopic.SUICIDE_DEATH:
            return confidence >= 0.2
        
        # å…¶ä»–æ•æ„Ÿè­°é¡Œï¼šæ¨™æº–é–¾å€¼
        return confidence >= threshold


# å…¨å±€å¯¦ä¾‹
_detector_instance = None


def get_sensitive_topic_detector() -> SensitiveTopicDetector:
    """å–å¾—æ•æ„Ÿè­°é¡Œæª¢æ¸¬å™¨å¯¦ä¾‹ï¼ˆå–®ä¾‹ï¼‰"""
    global _detector_instance
    if _detector_instance is None:
        _detector_instance = SensitiveTopicDetector()
    return _detector_instance

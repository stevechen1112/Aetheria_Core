import os
import sys
from dotenv import load_dotenv
from src.utils.gemini_client import GeminiClient

load_dotenv()

def test_chen_ziwei():
    # 模擬 server.py 中的 INITIAL_ANALYSIS_PROMPT
    INITIAL_ANALYSIS_PROMPT = """你好，我是 Aetheria。很高興能為你解讀這張紫微鬥數命盤。

請為以下用戶提供完整的紫微鬥數命盤分析：

出生日期：{birth_date}
出生時間：{birth_time}
出生地點：{birth_location}
性別：{gender}

【重要排盤邏輯：晚子時處理】
若出生時間在 23:00 - 00:00 之間（晚子時），請務必遵循以下原則：
1. **日期不進位**：以該「出生日期」當天作為排盤基準（不跳到隔日）。
2. **時辰為子時**：時辰支為「子」。
3. **命身宮位置**：以該日（晚子時）對應的宮位排布。

【格式要求】
1. 使用 Markdown 格式輸出
2. 標題層級：主要部分使用 ###，子部分使用 ####
3. 重點使用 **粗體**
4. 分隔線使用 ---
5. JSON 區塊務必保留在 「### 【結構化命盤資料】」 之下

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

### 【結構化命盤資料】
請務必先輸出以下 JSON 格式數據，封裝在 ```json 區塊中：
{{
  "五行局": "火六局 等",
  "命宮": {{
    "地支": "地支",
    "主星": ["星1", "星2"],
    "輔星": ["輔星1"]
  }},
  "身宮": {{
    "地支": "地支",
    "主星": ["星1"]
  }},
  "十二宮": {{
    "命宮": {{"地支": "X", "主星": ["星1"]}},
    "兄弟宮": {{"地支": "X", "主星": ["星1"]}},
    "夫妻宮": {{"地支": "X", "主星": ["星1"]}},
    "子女宮": {{"地支": "X", "主星": ["星1"]}},
    "財帛宮": {{"地支": "X", "主星": ["星1"]}},
    "疾厄宮": {{"地支": "X", "主星": ["星1"]}},
    "遷移宮": {{"地支": "X", "主星": ["星1"]}},
    "交友宮": {{"地支": "X", "主星": ["星1"]}},
    "官祿宮": {{"地支": "X", "主星": ["星1"]}},
    "田宅宮": {{"地支": "X", "主星": ["星1"]}},
    "福德宮": {{"地支": "X", "主星": ["星1"]}},
    "父母宮": {{"地支": "X", "主星": ["星1"]}}
  }},
  "四化": {{
    "化祿": "星名",
    "化權": "星名",
    "化科": "星名",
    "化忌": "星名"
  }},
  "格局": ["格局1", "格局2"]
}}

---

【紫微鬥數命盤圖】
請繪製 4x4 的 ASCII 命盤圖，確保 12 宮位對齊。

---

#### 一、命盤基礎結構：[加上具體描述]

1. **時辰判定與命身同宮**：說明時辰處理（如晚子時）與命身宮位置的意義。
2. **命宮主星**：詳細解析主星特質。
3. **核心格局**：解析如「機月同梁」等格局的社會定位。

#### 二、十二宮深度解讀
（依序分析重要宮位：命宮、財帛宮、官祿宮、夫妻宮、兄弟宮、遷移宮等）

#### 三、性格特質與人生建議
1. **核心性格關鍵詞**
2. **事業方向建議**
3. **人際與感情建議**
4. **2026年流年提示**

Aetheria 的總結：結尾寄語。
"""

    client = GeminiClient(
        api_key=os.getenv('GEMINI_API_KEY'),
        model_name='gemini-2.0-flash-exp'
    )

    prompt = INITIAL_ANALYSIS_PROMPT.format(
        birth_date="1979-11-12",
        birth_time="23:58",
        birth_location="台灣彰化市",
        gender="男性"
    )

    print("正在生成陳宥竹的紫微分析報告...")
    response = client.generate(prompt)
    
    with open("chen_ziwei_test_result.md", "w", encoding="utf-8") as f:
        f.write(response)
    
    print("\n--- 測試結果 (擷取) ---")
    print(response[:800] + "...")
    print("\n完整結果已儲存至 chen_ziwei_test_result.md")

if __name__ == "__main__":
    if not os.getenv('GEMINI_API_KEY'):
        print("錯誤：請先設定 GEMINI_API_KEY 環境變數。")
    else:
        test_chen_ziwei()
